# -*- after-save-hook: (org-babel-tangle); before-save-hook: (delete-trailing-whitespace)-*-

#+TITLE: Lambert's Emacs Configuration
#+AUTHOR: Lambert Green
#+PROPERTY: header-args:emacs-lisp :exports code :results none :tangle init.el

* In the beginning
** Bootstrap Elpaca Package Manager
    A package manager got bootstrapped and started sending things packing.
    #+begin_src emacs-lisp
    ;;; init.el --- -*- lexical-binding: t; -*-

    ;; Use Elpaca for our package manager
    (defvar elpaca-installer-version 0.6)
    (defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
    (defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
    (defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
    (defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
				    :ref nil
				    :files (:defaults "elpaca-test.el" (:exclude "extensions"))
				    :build (:not elpaca--activate-package)))
    (let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
	    (build (expand-file-name "elpaca/" elpaca-builds-directory))
	    (order (cdr elpaca-order))
	    (default-directory repo))
	(add-to-list 'load-path (if (file-exists-p build) build repo))
	(unless (file-exists-p repo)
	(make-directory repo t)
	(when (< emacs-major-version 28) (require 'subr-x))
	(condition-case-unless-debug err
	    (if-let ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
		    ((zerop (call-process "git" nil buffer t "clone"
					    (plist-get order :repo) repo)))
		    ((zerop (call-process "git" nil buffer t "checkout"
					    (or (plist-get order :ref) "--"))))
		    (emacs (concat invocation-directory invocation-name))
		    ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
					    "--eval" "(byte-recompile-directory \".\" 0 'force)")))
		    ((require 'elpaca))
		    ((elpaca-generate-autoloads "elpaca" repo)))
		(progn (message "%s" (buffer-string)) (kill-buffer buffer))
		(error "%s" (with-current-buffer buffer (buffer-string))))
	    ((error) (warn "%s" err) (delete-directory repo 'recursive))))
	(unless (require 'elpaca-autoloads nil t)
	(require 'elpaca)
	(elpaca-generate-autoloads "elpaca" repo)
	(load "./elpaca-autoloads")))
    (add-hook 'after-init-hook #'elpaca-process-queues)
    (elpaca `(,@elpaca-order))
    #+end_src

** Enable ~elpaca~ support for ~use-package~
    #+begin_src emacs-lisp
    ;; Install use-package support
    (elpaca elpaca-use-package
	;; Enable use-package :ensure support for Elpaca.
	(elpaca-use-package-mode))

    ;; Block until current queue processed.
    (elpaca-wait)
    #+end_src

* General Keybindings
  Space cadet follow your leader's orders!
    #+begin_src emacs-lisp
      (use-package general
	:ensure t
	:config
	(general-evil-setup)

	;; set up 'SPC' as the global leader key
	(general-create-definer lgreen/leader-keys
	  :states '(normal insert visual emacs)
	  :keymaps 'override
	  :prefix "SPC" ;; set leader
	  :global-prefix "M-SPC") ;; access leader in insert mode

	(lgreen/leader-keys
	  "SPC" '(execute-extended-command :wk "M-x")
	  "." '(find-file :wk "find-file"))

	;; Find files and things
	(lgreen/leader-keys
	  "f" '(:ignore t :wk "file")
	  "f f" '(find-file :wk "Find file")
	  "f r" '(recentf :wk "Recent files")
	  "f t" '(consult-todo :wk "Find todos")
	  "f T" '(consult-todo-all :wk "Find all todos")
	  "f c" '((lambda () (interactive) (find-file "~/.emacs.default/README.org")) :wk "Edit emacs config"))

	;; Search in files
	(lgreen/leader-keys
	  "s" '(:ignore t :wk "Search")
	  "s b" '(consult-line :wk "Search buffer")
	  "s p" '(consult-ripgrep :wk "Search project files")
	  "s i" '(consult-imenu :wk "Jump to symbol")
	  "s d" '(consult-locate :wk "Search current directory"))

	;; Projects
	(lgreen/leader-keys
	  "p" '(:ignore t :wk "project")
	  "p p" '(projectile-switch-project :wk "Switch project")
	  "p f" '(projectile-find-file :wk "Find file in project")
	  "p d" '(projectile-dired :wk "Dired in project")
	  "p b" '(projectile-switch-to-buffer :wk "Switch buffer in project"))

	;; Diff
	(lgreen/leader-keys
	  "d" '(:ignore t :wk "Diff")
	  "d p" '(diff-hl-previous-hunk :wk "Diff previous")
	  "d n" '(diff-hl-next-hunk :wk "Diff next"))

	;; Git Interface
	(lgreen/leader-keys
	  "g" '(:ignore t :wk "git")
	  "g g" '(magit-status :wk "Status"))

	;; Buffer Management
	(lgreen/leader-keys
	  "b" '(:ignore t :wk "buffer")
	  "b b" '(switch-to-buffer :wk "Switch buffer")
	  "b d" '(kill-this-buffer :wk "Delete buffer")
	  "b n" '(next-buffer :wk "Next buffer")
	  "b N" '(evil-buffer-new :wk "New buffer")
	  "b p" '(previous-buffer :wk "Previous buffer")
	  "b r" '(revert-buffer :wk "Reload buffer")
	  "b R" '(rename-buffer :wk "Rename buffer")
	  "b s" '(save-buffer :wk "Save buffer")
	  "b S" '(evil-write-all :wk "Save all buffers"))

	;; Window Management
	(lgreen/leader-keys
	  "w" '(:ignore t :wk "window")
	  "w =" '(balance-windows :wk "Balance windows")
	  "w h" '(evil-window-left :wk "Window left")
	  "w k" '(evil-window-up :wk "Window up")
	  "w j" '(evil-window-down :wk "Window down")
	  "w l" '(evil-window-right :wk "Window right")
	  "w q" '(evil-quit :wk "Window close")
	  "w d" '(delete-window :wk "Delete window")
	  "w s" '(split-window-below :wk "Split window below")
	  "w v" '(split-window-right :wk "Split window right")
	  "w o" '(delete-other-windows :wk "Delete other windows")
	  "w f" '(toggle-frame-fullscreen :wk "Toggle fullscreen")
	  "w m" '(toggle-frame-maximized :wk "Toggle maximized")
	  "w H" '(evil-window-move-far-left :wk "Move window far left")
	  "w K" '(evil-window-move-very-top :wk "Move window very top")
	  "w J" '(evil-window-move-very-bottom :wk "Move window very bottom")
	  "w L" '(evil-window-move-far-right :wk "Move window far right"))

	;; Help
	(lgreen/leader-keys
	  "h" '(:ignore t :wk "help")
	  "h f" '(helpful-callable :wk "Describe function")
	  "h v" '(helpful-variable :wk "Describe variable")
	  "h k" '(helpful-key :wk "Describe key")
	  "h c" '(helpful-command :wk "Describe command")
	  "h m" '(describe-mode :wk "Describe mode"))

	;; Toggles
	(lgreen/leader-keys
	  "t" '(:ignore t :wk "toggle")
	  "t l" '(display-line-numbers-mode :wk "Toggle line numbers")
	  "t w" '(visual-line-mode :wk "Toggle truncated lines"))

	;; Quit
	(lgreen/leader-keys
	  "q" '(:ignore t :wk "quit")
	  "q q" '(save-buffers-kill-terminal :wk "Quit"))

	;; Universal argument
	(lgreen/leader-keys
	  "u" '(universal-argument :wk "Universal argument")))
    #+end_src

* Evil Mode
** Evil
    #+begin_src emacs-lisp
      (use-package evil
	:ensure t
	:custom
	(evil-want-keybinding nil)
	(evil-want-C-u-scroll t)
	(evil-want-C-u-delete t)
	(org-return-follows-link t)
	:config
	;; Use Emacs keybindings in insert mode for C-a and C-e
	(define-key evil-insert-state-map (kbd "C-a") 'move-beginning-of-line)
	(define-key evil-insert-state-map (kbd "C-e") 'move-end-of-line)
	(evil-set-initial-state 'eat-mode 'insert)
	(evil-mode))
    #+end_src

** Evil Collection
    #+begin_src emacs-lisp
      ;; vim-like keybindings everywhere in emacs
      (use-package evil-collection
	:ensure t
	:after evil
	:config
	(evil-collection-init)
	;; Unmap keys in 'evil-maps. If not done, (setq org-return-follows-link t) will not work
	(with-eval-after-load 'evil-maps
	  (define-key evil-motion-state-map (kbd "SPC") nil)
	  (define-key evil-motion-state-map (kbd "RET") nil)
	  (define-key evil-motion-state-map (kbd "TAB") nil)))
    #+end_src

** Evil Lion
    #+begin_src emacs-lisp
      ;; gl and gL operators, like vim-lion
      (use-package evil-lion
	:ensure t
	:bind (:map evil-normal-state-map
		    ("gl " . evil-lion-left)
		    ("gL " . evil-lion-right)
		    :map evil-visual-state-map
		    ("gl " . evil-lion-left)
		    ("gL " . evil-lion-right)))
    #+end_src

** Evil Commentary
    #+begin_src emacs-lisp
      ;; gc operator, like vim-commentary
      (use-package evil-commentary
	:ensure t
	:after evil
	:config (evil-commentary-mode))
    #+end_src

** Evil Exchange
    #+begin_src emacs-lisp
      ;; gx operator, like vim-exchange
      ;; NOTE using cx like vim-exchange is possible but not as straightforward
      (use-package evil-exchange
	:ensure t
	:bind (:map evil-normal-state-map
		    ("gx" . evil-exchange)
		    ("gX" . evil-exchange-cancel)))
    #+end_src

** Evil Replace-with-register
    #+begin_src emacs-lisp
      ;; gr operator, like vim's ReplaceWithRegister
      (use-package evil-replace-with-register
	:ensure t
	:bind (:map evil-normal-state-map
		    ("gr" . evil-replace-with-register)
		    :map evil-visual-state-map
		    ("gr" . evil-replace-with-register)))
    #+end_src

** Evil VisualStar
    #+begin_src emacs-lisp
      ;; * operator in visual mode
      (use-package evil-visualstar
	:ensure t
	:bind (:map evil-visual-state-map
		    ("*" . evil-visualstar/begin-search-forward)
		    ("#" . evil-visualstar/begin-search-backward)))
    #+end_src

** Evil Expat
    #+begin_src emacs-lisp
      ;; ex commands, which a vim user is likely to be familiar with
      (use-package evil-expat :ensure t)
    #+end_src

** Evil Goggles
    #+begin_src emacs-lisp
      ;; visual hints while editing
      (use-package evil-goggles
	:ensure t
	:config
	(evil-goggles-use-diff-faces)
	(evil-goggles-mode))
    #+end_src

** Evil Surround
    #+begin_src emacs-lisp
      ;; like vim-surround
      (use-package evil-surround
	:ensure t
	:commands
	(evil-surround-edit
	 evil-Surround-edit
	 evil-surround-region
	 evil-Surround-region)
	:init
	(evil-define-key 'operator global-map "s" 'evil-surround-edit)
	(evil-define-key 'operator global-map "S" 'evil-Surround-edit)
	(evil-define-key 'visual global-map "S" 'evil-surround-region)
	(evil-define-key 'visual global-map "gS" 'evil-Surround-region))
    #+end_src

* Emacs Settings
    #+begin_src emacs-lisp
      (use-package emacs
	:ensure nil
	:config

	;; Set custom file so that customizations are not written here
	(setq custom-file (expand-file-name "custom.el" user-emacs-directory))
	(load custom-file)

	;; Set personal info
	(setq user-full-name "Lambert Green"
	      user-mail-address "lambert.green@gmail.com")

	;; Font
	(set-face-attribute 'default nil :font "Iosevka Nerd Font" :height 140)

	;; Visuals
	(scroll-bar-mode -1)        ; Disable visible scrollbar
	(tool-bar-mode -1)          ; Disable the toolbar
	(tooltip-mode -1)           ; Disable tooltips

	(setq use-short-answers t)

	;; Not sure this should be in the config.. maybe better in .dir-local.el files?
	(setq require-final-newline t))
    #+end_src

* No littering
    #+begin_src emacs-lisp
      (use-package no-littering
	:ensure t
	:config
	(no-littering-theme-backups))
    #+end_src

* UI Enhancements
** Themes
*** Catppuccin Theme
    #+begin_src emacs-lisp
      ;; Get a beautiful and functional theme
      (use-package catppuccin-theme
	:ensure t
	:config (load-theme 'catppuccin :no-confirm))
    #+end_src

** Modeline
    #+begin_src emacs-lisp
      ;; Add Doom's modeline
      (use-package doom-modeline
	:ensure t
	:init (doom-modeline-mode 1)
	:custom ((doom-modeline-height 20)))

      ;; Let's try this other modeline shall we?
      ;; (use-package telephone-line
      ;;   :init (telephone-line-mode 1))
    #+end_src

** Highlighting
*** TODOs
+ BUG There is an issue with =hl-todo= showing as version 0, which prevents =Elpaca= from installing =magit-todos= and =consult-todo=.
    #+begin_src emacs-lisp
      (use-package hl-todo
	:ensure t
	:hook ((org-mode . hl-todo-mode)
	       (prog-mode . hl-todo-mode))
	:config
	(setq hl-todo-highlight-punctuation ":"
	      hl-todo-keyword-faces
	      `(("TODO"       warning bold)
		("FIXME"      error bold)
		("BUG"        error bold)
		("HACK"       font-lock-constant-face bold)
		("REVIEW"     font-lock-keyword-face bold)
		("NOTE"       success bold)
		("DEPRECATED" font-lock-doc-face bold))))

      ;; (use-package magit-todos
      ;;   :ensure t
      ;;   :after magit
      ;;   :config (magit-todos-mode 1))

      ;; (use-package consult-todo
      ;;   :ensure t
      ;;   :after consult
      ;;   :commands (consult-todo consult-todo-all)
    #+end_src

** Nerd Icons
    #+begin_src emacs-lisp
      (use-package nerd-icons
	:ensure t)

      (use-package nerd-icons-dired
	:ensure t
	:after (:all nerd-icons dired)
	:hook (dired-mode . nerd-icons-dired-mode))

      (use-package nerd-icons-completion
	:ensure t
	:after marginalia
	:config
	(nerd-icons-completion-mode)
	(add-hook 'marginalia-mode-hook #'nerd-icons-completion-marginalia-setup))
    #+end_src

* OS Specifics
** Environment
    #+begin_src emacs-lisp
      ;; Set a useful $PATH
      (use-package exec-path-from-shell
	:ensure t
	:if (memq window-system '(mac ns))
	:config
	(exec-path-from-shell-initialize))
    #+end_src

** MacOS
    #+begin_src emacs-lisp
      (use-package emacs
	:ensure nil
	:if (memq window-system '(mac ns))
	:config
	(setq insert-directory-program "gls"
	      dired-use-ls-dired t))

    #+end_src

* Emacs Enhancement
** Which-key
    #+begin_src emacs-lisp
      (use-package which-key
	:ensure t
	:init (which-key-mode)
	:config
	(setq which-key-min-display-lines 3)
	(setq which-key-sort-uppercase-first nil))
    #+end_src

** Consult
    #+begin_src emacs-lisp
      (use-package consult
	:ensure t
	;; Enable automatic preview at point in the *Completions* buffer. This is
	;; relevant when you use the default completion UI.
	:hook (completion-list-mode . consult-preview-at-point-mode)
	:init
	;; Optionally configure the register formatting. This improves the register
	;; preview for `consult-register', `consult-register-load',
	;; `consult-register-store' and the Emacs built-ins.
	(setq register-preview-delay 0.5
	      register-preview-function #'consult-register-format)

	;; Optionally tweak the register preview window.
	;; This adds thin lines, sorting and hides the mode line of the window.
	(advice-add #'register-preview :override #'consult-register-window)

	;; Use Consult to select xref locations with preview
	(setq xref-show-xrefs-function #'consult-xref
	      xref-show-definitions-function #'consult-xref)
	)
    #+end_src

** Savehist
    #+begin_src emacs-lisp
      ;; Persist history over Emacs restarts. Vertico sorts by history position.
      (use-package savehist
	:init
	(savehist-mode))
    #+end_src

** Vertico
    VERTical Interactive COmpletion
    #+begin_src emacs-lisp
      ;; Enable vertico
      (use-package vertico
	:ensure t
	:init
	(vertico-mode)
	;; Different scroll margin
	(setq vertico-scroll-margin 0)
	;; Show more candidates
	(setq vertico-count 20)
	;; Grow and shrink the Vertico minibuffer
	(setq vertico-resize t)
	(setq vertico-cycle t))

      ;; A few more useful configurations...
      (use-package emacs
	:ensure nil
	:init
	;; Add prompt indicator to `completing-read-multiple'.
	;; We display [CRM<separator>], e.g., [CRM,] if the separator is a comma.
	(defun crm-indicator (args)
	  (cons (format "[CRM%s] %s"
			(replace-regexp-in-string
			 "\\`\\[.*?]\\*\\|\\[.*?]\\*\\'" ""
			 crm-separator)
			(car args))
		(cdr args)))
	(advice-add #'completing-read-multiple :filter-args #'crm-indicator)

	;; Do not allow the cursor in the minibuffer prompt
	(setq minibuffer-prompt-properties
	      '(read-only t cursor-intangible t face minibuffer-prompt))
	(add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

	;; Emacs 28: Hide commands in M-x which do not work in the current mode.
	;; Vertico commands are hidden in normal buffers.
	;; TODO Evaluate if you want to keep this setting
	(setq read-extended-command-predicate
	      #'command-completion-default-include-p)

	;; Enable recursive minibuffers
	(setq enable-recursive-minibuffers t))
    #+end_src

** Orderless
    Completion style for matching regexps in any order
    #+begin_src emacs-lisp
      (use-package orderless
	:ensure t
	:custom
	(completion-styles '(orderless basic))
	(completion-category-overrides '((file (styles basic partial-completion)))))
    #+end_src

** Marginalia
    Enrich existing commands with completion annotations
    #+begin_src emacs-lisp
      (use-package marginalia
	:ensure t
	;; Bind `marginalia-cycle' locally in the minibuffer.  To make the binding
	;; available in the *Completions* buffer, add it to the
	;; `completion-list-mode-map'.
	:bind (:map minibuffer-local-map
		    ("M-A" . marginalia-cycle))

	:init (marginalia-mode))
    #+end_src

** Helpful
    #+begin_src emacs-lisp
      (use-package helpful
	:ensure t)
    #+end_src

** Rainbow-delimiters
    #+begin_src emacs-lisp
      (use-package rainbow-delimiters
	:ensure t
	:hook (prog-mode . rainbow-delimiters-mode))
    #+end_src

** Undo
    #+begin_src emacs-lisp
      ;; use the powerful 'undo-tree'
      ;; "What good is a mind if you can't change it"
      (use-package undo-tree
	:ensure t
	:custom
	(evil-undo-system 'undo-tree)
	:init
	(global-undo-tree-mode))
    #+end_src

** Smartparens
    #+begin_src emacs-lisp
    (use-package smartparens
	:ensure t
	:config
	(smartparens-global-mode 1))
    #+end_src

* Completions
    #+begin_src emacs-lisp
    (use-package company
	:ensure t
	:init
	(setq company-idle-delay 0.1  ; Show suggestions after a small delay
	    company-minimum-prefix-length 2 ; Start completing after 2 characters
	    company-show-numbers t) ; Show numbers for easy selection
	:config
	(global-company-mode t)) ; Enable Company mode globally
    #+end_src

* Snippets
** Yasnippet
    #+begin_src emacs-lisp
      (use-package yasnippet-snippets
	:ensure t
	:hook (prog-mode . yas-minor-mode))
    #+end_src

** Lorem-ipsum
    #+begin_src emacs-lisp
      (use-package lorem-ipsum :ensure t)
    #+end_src

* Org
** Org Mode
    #+begin_src emacs-lisp
      (use-package org
	:ensure nil
	:config
	(require 'org-tempo))
    #+end_src

** Org Superstar
    + Yes this better bullets.
      - after
    #+begin_src emacs-lisp
	  (use-package org-superstar
	      :ensure t
	      :hook (org-mode . (lambda () (org-superstar-mode 1))))
    #+end_src

** Evil Org
    #+begin_src emacs-lisp
      (use-package evil-org
	:ensure t
	:after org
	:hook ((org-mode . evil-org-mode)
	       (evil-org-mode . evil-org-set-key-theme))
	:config
	(evil-define-key 'normal evil-org-mode-map
	  (kbd "M-k") #'org-metaup
	  (kbd "M-j") #'org-metadown))
    #+end_src

* Projects
    #+begin_src emacs-lisp
      (use-package projectile
	:ensure t
	:config
	(projectile-mode +1)
	(setq projectile-project-search-path '(("~/dev" . 7))))
    #+end_src

* Version Control
** Magit
    #+begin_src emacs-lisp
      (use-package magit
	:ensure t
	:config
	(setq magit-diff-refine-hunk t))
    #+end_src

** Diff-HL
    #+begin_src emacs-lisp
      (use-package diff-hl
	:ensure t
	:config
	(global-diff-hl-mode))
    #+end_src

* Terminals
** Emulate A Terminal (EAT)
    #+begin_src emacs-lisp
      (use-package eat
	:ensure t)
    #+end_src

* Programming
** LSP
    #+begin_src emacs-lisp :tangle no
      (use-package lsp-mode)
    #+end_src

* My Functions
    #+begin_src emacs-lisp
      (use-package emacs
	:config

	;; Set transparency of emacs
	(defun lgreen/transparency (value)
	  "Sets the transparency of the frame window. 0=transparent/100=opaque"
	  (interactive "nTransparency Value 0 - 100 opaque:")
	  (set-frame-parameter (selected-frame) 'alpha value)))
    #+end_src

* Rest
We are slowly migrating our config into a literate config.  This section is the non-migrated stuff.
#+begin_src emacs-lisp
  (use-package dired-narrow :ensure t)
  (use-package origami :ensure t)
#+end_src
